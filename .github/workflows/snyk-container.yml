name: Snyk Container

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '17 1 * * 0'

permissions:
  contents: read

jobs:
  snyk:
    permissions:
      contents: read
      security-events: write
      actions: read
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Snyk CLI
      uses: snyk/actions/setup@master
      with:
        version: 'latest'  # or pin a specific version like '1.1020.0'


    - name: Build Docker image
      run: docker build -t burnettdev/adsb2loki .

    - name: Run Snyk container test and generate SARIF
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        SNYK_API: https://api.eu.snyk.io
      run: |
        snyk container test burnettdev/adsb2loki \
          --file=Dockerfile \
          --sarif-file-output=snyk.sarif

    - name: Sanitize SARIF file
      run: |
        if [ -f "snyk.sarif" ]; then
          echo "Sanitizing SARIF file..."
          jq '
            def fix_security_severity:
              if type == "object" then
                with_entries(
                  if .key == "security-severity" and (.value == null or .value == "null") then
                    .value = "0"
                  else
                    .value |= fix_security_severity
                  end
                )
              elif type == "array" then
                map(fix_security_severity)
              else
                .
              end;
            fix_security_severity
          ' snyk.sarif > snyk_sanitized.sarif

          mv snyk_sanitized.sarif snyk.sarif
        else
          echo "No SARIF file found to sanitize."
        fi

    - name: Upload SARIF to GitHub Code Scanning
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: snyk.sarif
